# Architecture Decision Record: Replacing 'ksuid' with 'uuidv7' for Globally Unique Identifiers

**Date:** 2024-05-28

## Context

We initially chose 'ksuid' as the library for generating globally unique identifiers (GUIDs) due to its ability to generate sortable IDs based on time. This feature is especially beneficial in event-driven systems where events are ordered by time, allowing us to sort events by GUID without introducing an additional date/time column in the database.

## Problem

While 'ksuid' has served us well, we encountered an issue with its inability to sort IDs with millisecond precision. Given two GUIDs with the same timestamp down to the hour, minute, and second, the sort order is not guaranteed if they differ by milliseconds. This limitation prompted the introduction of a version field in our database tables to ensure the correct sequential ordering of events, a practice supported by research.

## Decision

After [reaching out](https://github.com/novemberborn/ksuid/issues/28) to the author of 'ksuid', it was confirmed that the limitation in millisecond precision sorting is by design. The author recommended considering 'uuidv7', which offers sortable GUIDs with sub-millisecond accuracy and is gaining adoption in the community.

## Pros and Cons

### Pros

1. **Robust Implementation**: 'uuidv7' is recognized for its reliable implementation.
2. **Sub-Millisecond Accuracy**: Ensures precise ordering of events.
3. **Future-Proof**: With growing adoption, 'uuidv7' is expected to have long-term support.

### Cons

1. **Length of IDs**: 'uuidv7' generates IDs that are 32 digits long compared to 'ksuid's 27 digits. However, this can be mitigated by using a case-insensitive base36 encoding to condense the ID to 25 digits if necessary.
2. **Exposure of Date/Time Information**: Some critics suggest that time-sortable IDs like those generated by 'ksuid' and 'uuidv7' expose date/time information to the public. Conversely, some may see this as an advantage if they rely solely on the ID to store timestamp information. In our event-driven system, we use the ID for primary key identification, and the ID itself isn't enough to provide any sensitive data to the public since events are often ordered and played back in the internal domain model to serve a significant purpose.

## Decision Outcome

We have decided to transition from 'ksuid' to 'uuidv7' for generating GUIDs in our system. This change will enhance the precision of event ordering without requiring significant alterations to the existing database schema.

## Unchanged Elements

1. **Event Versioning**: Despite this transition, the practice of event versioning will continue. This aspect is considered a separate concern from the GUID generation and remains a best practice in ensuring the integrity of event sequences.
2. **Natural Sorting**: Natural sorting used in programming languages and databases will work the same way. Both 'ksuid' and 'uuidv7' values are time-sortable, allowing database indexing mechanisms to better optimize storage and retrieval processes, leading to faster query times, especially for time-based queries.
3. **API Support**: Both libraries reliably support common use cases such as comparison, parsing, validation, creating an ID with a given timestamp, and extracting parts from a generated ID. While these APIs are useful, we will not be passing a timestamp to generate an ID at the moment, as we prefer to delegate the responsibility of generating and storing random IDs solely to the library rather than relying on the domain model to provide a date/time value.

## Implementation Plan

1. **Library Integration**: Integrate the 'uuidv7' library into the system.
2. **Testing**: Conduct thorough testing to ensure the new GUIDs are generated and sorted correctly.
3. **Database Updates**: If necessary, update any database columns to accommodate the new GUID format.
4. **Documentation**: Update internal documentation to reflect the changes in the GUID generation process.
5. **Deployment**: Deploy the changes to the production environment following successful testing.

## Conclusion

Switching to 'uuidv7' will address the precision issues we encountered with 'ksuid', providing a more reliable solution for our event-driven system. This decision supports our ongoing efforts to improve system performance and data integrity.
